name: Build OnePlus 7 EmberHeart Kernel

permissions:
  contents: write
  actions: write

inputs:
  ksun_branch:
    required: true
    type: string
    default: stable
  susfs_commit_hash_or_branch:
    required: false
    type: string
    default: ""
  optimize_level:
    required: false
    type: string
    default: O2  # Choices: O2 or O3
  kernel_uname:
    required: false
    type: string
    default: "EmberHeart"
  branch:
    required: true
    type: string
    default: 'lineage-23.0'

outputs:
  kernel_version:
    value: ${{ steps.save_metadata.outputs.kernel_version }}
  ksu_version:
    value: ${{ steps.save_metadata.outputs.ksu_version }}
  susfs_version:
    value: ${{ steps.save_metadata.outputs.susfs_version }}
  image_sha256:
    value: ${{ steps.collect_stats.outputs.image_sha256 }}
  warnings:
    value: ${{ steps.collect_stats.outputs.warnings }}

runs:
  using: composite
  steps:
    - name: Install Minimal Dependencies
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Install deps"
        sudo apt-get -o Acquire::Retries=3 update -qq
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          git curl ca-certificates build-essential clang lld flex bison \
          libelf-dev libssl-dev libncurses-dev zlib1g-dev liblz4-tool \
          libxml2-utils rsync unzip dwarves file python3 ccache
        sudo apt-get clean
        echo "::endgroup::"

    - name: Setup Base Environment
      shell: bash
      run: |
        set -euo pipefail
        # Derive a unique build directory name
        CONFIG="OP7"
        echo "OP_MODEL=OP7" >> "$GITHUB_ENV"
        echo "CONFIG=$CONFIG" >> "$GITHUB_ENV"
        echo "BRANCH=${{ inputs.branch }}" >> "$GITHUB_ENV"

    - name: Initialize and Sync Kernel Source
      shell: bash
      run: |
        set -euo pipefail
        echo "Creating folder for configuration: $CONFIG"
        mkdir -p "$CONFIG/kernel_platform"
        cd "$CONFIG/kernel_platform"
        git clone --depth=1 --branch $BRANCH https://github.com/LineageOS/android_kernel_oneplus_sm8150 common
        cd common
        git submodule update --init --recursive

    - name: Get Kernel Version Info
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        mkdir -p "$ARTIFACTS_DIR"
        cd "$CONFIG_DIR/kernel_platform/common"
        
        VERSION=$(grep '^VERSION *=' Makefile | awk '{print $3}')
        PATCHLEVEL=$(grep '^PATCHLEVEL *=' Makefile | awk '{print $3}')
        SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | awk '{print $3}')
        FULL_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"
        cd "$ARTIFACTS_DIR"
        echo "$FULL_VERSION" > "${OP_MODEL}.txt"
        echo "KERNEL_VER=$VERSION.$PATCHLEVEL" >> "$GITHUB_ENV"
        echo "KERNEL_FULL_VER=$FULL_VERSION" >> "$GITHUB_ENV"
        echo "SUSFS_KERNEL_BRANCH=kernel-$VERSION.$PATCHLEVEL" >> "$GITHUB_ENV"

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2.19
      with:
        key: ${{ env.CONFIG }}-kernel-${{ env.KERNEL_FULL_VER }}
        max-size: 5G
        append-timestamp: false
        create-symlink: true
        job-summary: 'CCache stats'
        evict-old-files: 'job'

    - name: Clone AnyKernel3 and Other Dependencies
      shell: bash
      run: |
        set -euo pipefail
        echo "Cloning AnyKernel3 and other dependencies..."
        git clone https://github.com/khalidaboelmagd/AnyKernel3
        git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git
        git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 clang
        git clone --depth=1 https://github.com/0x-br0k3n/kernel_patches.git my_patches

    - name: Add BBG
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        echo "Adding BBG..."
        wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
        echo "CONFIG_BBG=y" >> common/arch/arm64/configs/lineage_sm8150_defconfig
        sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' common/security/Kconfig

    - name: Add KernelSU Next
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        echo "Adding KernelSU Next..."
        if [ "${{ inputs.ksun_branch }}" = "stable" ]; then
          curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -
        else
          curl --fail --location --proto '=https' -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s "${{ inputs.ksun_branch }}"
        fi
        git submodule update --init --recursive
        cd KernelSU-Next
        KSUN_COMMIT_SHA=ce0ff7395188490934fb1b67446b6a351f22a2b4
        # git checkout $KSUN_COMMIT_SHA
        echo "KSUN_COMMIT_SHA=$KSUN_COMMIT_SHA" >> $GITHUB_ENV
        cd ..

    - name: Apply SUSFS Patches
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform/common"
        echo "Applying SUSFS patches..."
        patch -p1 < ../../../my_patches/kernel_patches/backports/4.14/SuSFS_1.5.9_backport.patch || true
        
    - name: Apply KSUN Hooks
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform/common"
        patch -p1 < ../../../kernel_patches/next/scope_min_manual_hooks_v1.4.patch || true
        
    - name: Add KernelSU-Next and SUSFS Configuration Settings
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        # Remove indentation to avoid leading spaces
        cat >> common/arch/arm64/configs/lineage_sm8150_defconfig <<EOF
        CONFIG_KSU=y
        CONFIG_KSU_KPROBES_HOOK=n
        CONFIG_KSU_SUSFS=y
        CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_PATH=y
        CONFIG_KSU_SUSFS_SUS_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SUS_KSTAT=y
        CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
        CONFIG_KSU_SUSFS_TRY_UMOUNT=y
        CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
        CONFIG_KSU_SUSFS_SPOOF_UNAME=y
        CONFIG_KSU_SUSFS_ENABLE_LOG=y
        CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
        CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
        CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
        CONFIG_KSU_SUSFS_SUS_MAP=y
        CONFIG_KSU_SUSFS_SUS_SU=n
        CONFIG_TMPFS_XATTR=y
        CONFIG_TMPFS_POSIX_ACL=y
        EOF

    - name: Add Oneplus BBR
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        cat >> common/arch/arm64/configs/lineage_sm8150_defconfig <<EOF
        CONFIG_TCP_CONG_ADVANCED=y
        CONFIG_TCP_CONG_BBR=y
        CONFIG_NET_SCH_FQ=y
        CONFIG_NET_SCH_FQ_CODEL=y
        EOF

    - name: Add Nethunter inline configs
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        cat >> common/arch/arm64/configs/lineage_sm8150_defconfig <<EOF
        CONFIG_BT_HCIBTUSB=y
        CONFIG_BT_HCIBTUSB_BCM=y
        CONFIG_BT_HCIBTUSB_RTL=y
        CONFIG_BT_HCIVHCI=y
        CONFIG_BT_HCIBCM203X=y
        CONFIG_BT_HCIBPA10X=y
        CONFIG_BT_HCIBFUSB=y
        
        CONFIG_USB_AIRSPY=y
        CONFIG_USB_HACKRF=y
        
        CONFIG_CAN=y
        CONFIG_CAN_DEV=y
        CONFIG_CAN_CALC_BITTIMING=y
        CONFIG_CAN_LEDS=y
        CONFIG_CAN_VCAN=y
        
        CONFIG_CAN_GRCAN=y
        CONFIG_CAN_XILINXCAN=y
        
        # Bosch C_CAN/D_CAN devices
        CONFIG_CAN_C_CAN=y
        CONFIG_CAN_C_CAN_PLATFORM=y
        CONFIG_CAN_C_CAN_PCI=y
        
        # Bosch CC770 and Intel AN82527 devices
        CONFIG_CAN_CC770=y
        CONFIG_CAN_CC770_ISA=y
        CONFIG_CAN_CC770_PLATFORM=y
        
        # Bosch M_CAN devices
        CONFIG_CAN_M_CAN=y
        CONFIG_CAN_M_CAN_PCI=y
        CONFIG_CAN_M_CAN_PLATFORM=y
        CONFIG_CAN_M_CAN_TCAN4X5X=y
        
        # CAN SPI interfaces
        CONFIG_CAN_HI311X=y
        CONFIG_CAN_MCP251X=y
        
        # CAN USB interfaces
        CONFIG_CAN_8DEV_USB=y
        CONFIG_CAN_EMS_USB=y
        CONFIG_CAN_ESD_USB2=y
        CONFIG_CAN_GS_USB=y
        CONFIG_CAN_KVASER_USB=y
        CONFIG_CAN_PEAK_USB=y
        
        CONFIG_NETLINK_DIAG=y
        CONFIG_VSOCKETS=y
        
        CONFIG_NET_SCHED=y
        CONFIG_NET_EMATCH_CANID=y
        
        CONFIG_USB_SERIAL=y
        CONFIG_USB_SERIAL_CONSOLE=y
        CONFIG_USB_SERIAL_GENERIC=y
        CONFIG_USB_SERIAL_CH341=y
        CONFIG_USB_SERIAL_FTDI_SIO=y
        CONFIG_USB_SERIAL_PL2303=y
        EOF

    - name: Add TTL Target Support
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        cat >> common/arch/arm64/configs/lineage_sm8150_defconfig <<EOF
        CONFIG_IP_NF_TARGET_TTL=y
        CONFIG_IP6_NF_TARGET_HL=y
        CONFIG_IP6_NF_MATCH_HL=y
        EOF

    - name: Add IP SET Support
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        cat >> common/arch/arm64/configs/lineage_sm8150_defconfig <<EOF
        CONFIG_IP_SET=y
        CONFIG_IP_SET_MAX=65534
        CONFIG_IP_SET_BITMAP_IP=y
        CONFIG_IP_SET_BITMAP_IPMAC=y
        CONFIG_IP_SET_BITMAP_PORT=y
        CONFIG_IP_SET_HASH_IP=y
        CONFIG_IP_SET_HASH_IPMARK=y
        CONFIG_IP_SET_HASH_IPPORT=y
        CONFIG_IP_SET_HASH_IPPORTIP=y
        CONFIG_IP_SET_HASH_IPPORTNET=y
        CONFIG_IP_SET_HASH_IPMAC=y
        CONFIG_IP_SET_HASH_MAC=y
        CONFIG_IP_SET_HASH_NETPORTNET=y
        CONFIG_IP_SET_HASH_NET=y
        CONFIG_IP_SET_HASH_NETNET=y
        CONFIG_IP_SET_HASH_NETPORT=y
        CONFIG_IP_SET_HASH_NETIFACE=y
        CONFIG_IP_SET_LIST_SET=y
        EOF

    - name: Add Build based configs
      shell: bash
      run: |
        set -euo pipefail
        cd "$CONFIG/kernel_platform"
        cat >> common/arch/arm64/configs/lineage_sm8150_defconfig <<EOF
        CONFIG_LTO_CLANG_THIN=y
        CONFIG_LTO_CLANG=y
        CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
        CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE_O3=n
        CONFIG_OPTIMIZE_INLINING=y
        EOF

    - name: Save Build Metadata
      id: save_metadata
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        cd "$ARTIFACTS_DIR"
        echo "kernel_version=${{ env.KERNEL_FULL_VER }}" >> "$GITHUB_OUTPUT"
        echo "ksu_version=${KSUVER:-unknown}" >> "$GITHUB_OUTPUT"
        echo "susfs_version=${SUSVER:-unknown}" >> "$GITHUB_OUTPUT"

    - name: Customize Kernel Branding
      shell: bash
      run: |
        set -euo pipefail
        KERNEL_PATH="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        cd "$KERNEL_PATH/common"
        mkdir -p out
        CUSTOM_LOCALVERSION="-${{ inputs.kernel_uname }}"
        echo "CUSTOM_LOCALVERSION=$CUSTOM_LOCALVERSION" >> "$GITHUB_ENV"

    - name: Build Kernel
      shell: bash
      env:
        PYTHONWARNINGS: "ignore:invalid escape sequence"
      run: |
        set -euo pipefail
        echo "::group::Build kernel"
        KERNEL_PATH="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        COMMON="$KERNEL_PATH/common"
        cd "$COMMON"
        
        # Ensure Python warnings are suppressed for scripts invoked by make
        export PYTHONWARNINGS="${PYTHONWARNINGS}"
        
        export PATH=$GITHUB_WORKSPACE/toolchain/bin:/usr/lib/llvm-14/bin:$PATH
        
        export PATH="/usr/lib/ccache:$PATH"
        
        
        export ARCH=arm64 SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-android-
        export CROSS_COMPILE_COMPAT=arm-linux-androideabi-
        export HOSTCC=clang HOSTCXX=clang++
        export CC=ccache clang
        export CLANG_TRIPLE=aarch64-linux-gnu-
        OUT=out
        mkdir -p "$OUT"
        make O="$OUT" lineage_sm8150_defconfig
        
        # LOCALVERSION branding
        if [ -n "${CUSTOM_LOCALVERSION:-}" ]; then
          scripts/config --file "$OUT/.config" --set-str LOCALVERSION "${CUSTOM_LOCALVERSION}"
          scripts/config --file "$OUT/.config" -d LOCALVERSION_AUTO || true
          sed -i 's/scm_version="$(scm_version --short)"/scm_version=""/' scripts/setlocalversion
        fi
        
        # Optimize level config and flags
        if [ "${{ inputs.optimize_level }}" = "O3" ]; then
          scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
          KCFLAGS_EXTRA="-O3"
        else
          scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
          KCFLAGS_EXTRA="-O2"
        fi
        
        # Consistent flags; include -pipe and disable stack protector
        KCFLAGS="-Wno-error -pipe -fno-stack-protector ${KCFLAGS_EXTRA}"
        KCPPFLAGS="-DCONFIG_OPTIMIZE_INLINING"
        
        # Regenerate defaults after config edits
        make O="$OUT" olddefconfig
        
        echo "Starting build with $(nproc --all) threads..."
        set -o pipefail
        make -j"$(nproc --all)" O="$OUT" KCFLAGS="$KCFLAGS" KCPPFLAGS="$KCPPFLAGS" 2>&1 | tee build.log
        
        IMG="$OUT/arch/arm64/boot/Image"
        if [ ! -f "$IMG" ]; then
          echo "Kernel Image missing"
          exit 1
        fi
        sha256sum "$IMG" | tee "$OUT/Image.sha256"
        echo "::endgroup::"          

    - name: Collect Build Stats / Validate Image
      id: collect_stats
      shell: bash
      run: |
        set -euo pipefail
        KERNEL_PATH="$GITHUB_WORKSPACE/$CONFIG/kernel_platform"
        COMMON="$KERNEL_PATH/common"
        OUT="$COMMON/out"
        IMG="$OUT/arch/arm64/boot/Image"
    
        WARNINGS=$(grep -i -E 'warning:' "$COMMON/build.log" | wc -l || true)
        echo "$WARNINGS" > "$OUT/warnings.txt"
    
        if [ -f "$IMG" ]; then
          file "$IMG" > "$OUT/Image.file" || true
          KERNEL_UNAME=$(strings "$IMG" | grep -E 'Linux version.*#' | tail -n1 || true)
          echo "Kernel Uname: ${KERNEL_UNAME:-unknown}"
          echo "KERNEL_UNAME=${KERNEL_UNAME:-unknown}" >> "$GITHUB_ENV"
    
          if ! file "$IMG" | grep -qi 'ARM64'; then
            echo "WARNING: Image does not appear to be ARM64:"
            file "$IMG" || true
          fi
    
          MIN_SIZE=$((6*1024*1024))
          ACTUAL_SIZE=$(stat -c %s "$IMG" || echo 0)
          if [ "$ACTUAL_SIZE" -lt "$MIN_SIZE" ]; then
            echo "WARNING: Image size $ACTUAL_SIZE < $MIN_SIZE (suspicious)."
          fi
    
          CALC_SHA=$(sha256sum "$IMG" | cut -d' ' -f1)
          if [ -f "$OUT/Image.sha256" ]; then
            REC_SHA=$(cut -d' ' -f1 "$OUT/Image.sha256" | tr -d '\n')
            if [ "$CALC_SHA" != "$REC_SHA" ]; then
              echo "WARNING: Image.sha256 mismatch. recorded=$REC_SHA calculated=$CALC_SHA"
            fi
            IMAGE_SHA256="$REC_SHA"
          else
            echo "WARNING: Image.sha256 not found, using calculated sha256."
            IMAGE_SHA256="$CALC_SHA"
          fi
        else
          echo "WARNING: Image file not found at $IMG"
          IMAGE_SHA256=""
          KERNEL_UNAME="unknown"
          echo "KERNEL_UNAME=unknown" >> "$GITHUB_ENV"
        fi
    
        echo "Image sha256: ${IMAGE_SHA256:-none}"
        echo "warnings=$WARNINGS" >> "$GITHUB_OUTPUT"
        echo "image_sha256=${IMAGE_SHA256:-}" >> "$GITHUB_OUTPUT"

    - name: Create Kernel ZIP
      id: create_zip
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        IMAGE_PATH="$CONFIG_DIR/kernel_platform/common/out/arch/arm64/boot/Image"
        if [ ! -f "$IMAGE_PATH" ]; then
          echo "ERROR: Built Image not found"
          exit 1
        fi
    
        # Put Image into AnyKernel3
        cp "$IMAGE_PATH" "$GITHUB_WORKSPACE/AnyKernel3/Image"
        cd "$GITHUB_WORKSPACE/AnyKernel3"
        
        sed -i '7 c\kernel.string=EmberHeart Kernel by 0x-br0k3n' anykernel.sh
        
        ZIP_NAME="AnyKernel3_${OP_MODEL}_${{ env.KERNEL_FULL_VER }}_Next_${KSUVER}_${SUSVER}.zip"
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        mkdir -p "$ARTIFACTS_DIR"

        echo "Creating flashable zip: $ZIP_NAME"
        ( cd "$GITHUB_WORKSPACE/AnyKernel3" && zip -r "$ARTIFACTS_DIR/$ZIP_NAME" ./* >/dev/null )

        # Keep only the flashable zip and the model metadata file (assumed already created earlier)
        find "$ARTIFACTS_DIR" -maxdepth 1 -type f ! -name "$ZIP_NAME" ! -name "${OP_MODEL}.txt" -delete
    
        # Output for later steps (optional)
        echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"
        
    - name: Upload Boot Image
      if: success() && steps.create_zip.conclusion == 'success'
      shell: bash
      run: |
        set -euo pipefail
        CONFIG_DIR="$GITHUB_WORKSPACE/$CONFIG"
        IMAGE="$CONFIG_DIR/kernel_platform/common/out/arch/arm64/boot/Image"
        
        cd "$GITHUB_WORKSPACE"
        mkdir -p boot
        # Download stock boot image
        wget https://github.com/0x-br0k3n/EmberHeart_OnePlus11/raw/refs/heads/main/tools/boot.zip
        unzip boot.zip
        # Download magiskboot binary
        wget https://github.com/magojohnji/magiskboot-linux/raw/refs/heads/main/x86_64/magiskboot
        
        BOOT=$(ls | grep -E '*.img')
        MAGISKBOOT="./magiskboot"
        
        chmod +x $MAGISKBOOT
        
        echo -n "Unpacking boot image..."
        $MAGISKBOOT unpack $BOOT
        echo -n "Adding kernel to boot image..."
        mv -f $IMAGE kernel
        echo -n "Repacking boot image..."
        $MAGISKBOOT repack $BOOT
        
        mv -f new-boot.img EmberHeart_boot.img
        cp EmberHeart_boot.img "$CONFIG_DIR/artifacts/"     

    - name: Final Build Summary
      shell: bash
      run: |
        set -euo pipefail
        {
          echo "Model: ${OP_MODEL}"
          echo "Kernel base: ${{ env.KERNEL_VER }}"
          echo "Kernel full: ${{ env.KERNEL_FULL_VER }}"
          echo "Kernel Uname: ${{ env.KERNEL_UNAME }}"
          echo "KSUN Version: ${KSUVER:-unknown}"
          echo "KSUN commit SHA: ${{ env.KSUN_COMMIT_SHA }}"
          echo "SUSFS Version: ${SUSVER:-unknown}"
          echo "SUSFS commit SHA: ${{ env.SUSFS_COMMIT_SHA }}"
          echo "Optimization: ${{ inputs.optimize_level }}"
          echo "Image SHA256: ${{ steps.collect_stats.outputs.image_sha256 }}"
          echo "Compiler: ${CLANG_VERSION:-unknown}"
          echo ""
          echo "CCache Statistics :"
          echo "$(ccache -s -v)"
        } | tee summary.txt
        {
          echo "### Kernel Build Summary"
          echo ""
          echo "- Model: ${OP_MODEL}"
          echo "- Kernel Version: ${{ steps.save_metadata.outputs.kernel_version }}"
          echo "- Kernel Uname: ${{ env.KERNEL_UNAME }}"
          echo "- KSUN Version: ${KSUVER:-unknown}"
          echo "- KSUN commit SHA: [${{ env.KSUN_COMMIT_SHA }}](https://github.com/KernelSU-Next/KernelSU-Next/commit/${{ env.KSUN_COMMIT_SHA }})"
          echo "- SUSFS Version: ${SUSVER:-unknown}"
          echo "- SUSFS commit SHA: [${{ env.SUSFS_COMMIT_SHA }}](https://gitlab.com/simonpunk/susfs4ksu/-/commit/${{ env.SUSFS_COMMIT_SHA }})"
          echo "- Optimization: ${{ inputs.optimize_level }}"
          echo "- Image SHA256: ${{ steps.collect_stats.outputs.image_sha256 }}"
          echo ""
          echo "CCache Statistics :"
          echo "$(/usr/bin/ccache -s)"
        } >> "$GITHUB_STEP_SUMMARY"
        
    - name: Cleanup old ccache
      shell: bash
      run: |
        set -euo pipefail
        echo "Deleting old ccache..."
        gh cache delete ccache-${{ env.CONFIG }}-kernel-${{ env.KERNEL_FULL_VER }}- || true
        
    - name: Upload Artifacts
      if: success() && steps.create_zip.conclusion == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ env.CONFIG }}
        path: ${{ env.CONFIG }}/artifacts/
        
